<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PyJava_0515 掲示板 (デバッグ版)</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

body { font-family: "Press Start 2P", monospace; background-color: #111; color: #fefefe; margin:0; padding:0; }
header { background:#222; padding:14px; text-align:center; font-size:18px; color:#0ff; text-shadow:2px 2px #08f; box-shadow:0 3px 8px rgba(0,255,255,0.4); }
.container { max-width:700px; margin:15px auto; padding:15px; background:#1a1a1a; border:3px solid #0ff; border-radius:10px; box-shadow:0 0 10px #0ff; }
h3 { font-size:14px; color:#ff0; text-shadow:1px 1px #f00; margin-bottom:10px; }
input, textarea, select, button { width:100%; padding:10px; margin-bottom:8px; background:#222; color:#0ff; border:2px solid #0ff; border-radius:5px; font-family:"Press Start 2P", monospace; font-size:12px; resize:vertical; box-sizing:border-box; }
textarea { min-height:70px; }
button { background:#0ff; color:#000; cursor:pointer; box-shadow:2px 2px #08f; transition:all 0.2s; }
button:hover { background:#ff0; box-shadow:2px 2px #f80; }
button:disabled { background:#666; color:#333; cursor: not-allowed; }
.thread, .reply { border:2px solid #0ff; padding:10px; margin-bottom:10px; background:#111; border-radius:5px; box-shadow:0 0 8px #0ff; }
.thread { cursor:pointer; display:flex; justify-content:space-between; align-items:center; }
.reply { margin-left:20px; border-color:#ff80ff; box-shadow:0 0 6px #ff80ff; }
.delete-btn { color:#f44; cursor:pointer; font-size:10px; margin-left:10px; }
.lucky { margin:10px 0; padding:10px; background:#222; border:2px dashed #0ff; border-radius:5px; box-shadow:0 0 5px #0ff; font-size:12px; }
.welcome { font-size:12px; color:#0ff; text-align:center; margin-bottom:10px; }
.loading { color:#ff0; text-align:center; padding:10px; }
.error { color:#f44; text-align:center; padding:10px; }
.debug { background:#003300; color:#0f0; padding:10px; margin:10px 0; font-size:8px; border:1px solid #0f0; border-radius:3px; max-height:200px; overflow-y:auto; }
.status { background:#000033; color:#00ffff; padding:5px; margin:5px 0; font-size:10px; border:1px solid #00ffff; }
#threadView { display:none; }
@media screen and (max-width:600px) {
    body { font-size:10px; }
    .container { width:92%; padding:10px; }
    input, textarea, select, button { font-size:10px; padding:8px; }
    header { font-size:14px; }
    .welcome { font-size:10px; }
}
</style>
</head>
<body>
<header>PyJava_0515 掲示板 (デバッグ版)</header>

<div class="container" id="loginContainer">
    <h3>ログイン</h3>
    <input type="text" id="username" placeholder="ユーザー名">
    <button onclick="login()">ログイン</button>
</div>

<div class="container" id="mainContainer" style="display:none">
    <div class="welcome">ようこそ、<span id="currentUser"></span> さん！</div>
    
    <!-- デバッグ情報表示エリア -->
    <div class="status" id="statusInfo">システム状態: 初期化中...</div>
    <div class="debug" id="debugLog">デバッグログ:<br></div>
    <button onclick="clearDebugLog()" style="background:#333; font-size:8px; padding:3px;">ログクリア</button>
    <button onclick="testAPI()" style="background:#660066; font-size:8px; padding:3px;">API接続テスト</button>

    <div>
        <h3>占い</h3>
        <select id="zodiac">
            <option value="">選択してください</option>
            <option value="おうし座">おうし座</option>
            <option value="ふたご座">ふたご座</option>
            <option value="かに座">かに座</option>
            <option value="しし座">しし座</option>
            <option value="おとめ座">おとめ座</option>
            <option value="てんびん座">てんびん座</option>
            <option value="さそり座">さそり座</option>
            <option value="いて座">いて座</option>
            <option value="やぎ座">やぎ座</option>
            <option value="みずがめ座">みずがめ座</option>
            <option value="うお座">うお座</option>
        </select>
        <button onclick="showFortune()">占う</button>
        <div class="lucky" id="fortune"></div>
    </div>

    <h3>スレッド一覧</h3>
    <input type="text" id="title" placeholder="スレッドタイトル">
    <textarea id="threadContent" placeholder="本文を入力してください"></textarea>
    <button onclick="createThread()">新規スレッド作成</button>
    <div class="loading" id="loadingThreads">読み込み中...</div>
    <div id="threads"></div>

    <div id="threadView">
        <button onclick="backToList()">← スレッド一覧へ戻る</button>
        <h3 id="threadTitle"></h3>
        <p id="threadContentDisplay"></p>
        <div class="loading" id="loadingReplies">返信読み込み中...</div>
        <div id="replies"></div>
        <textarea id="replyContent" placeholder="返信内容"></textarea>
        <button onclick="addReply()">返信する</button>
    </div>

    <button onclick="resetAll()" style="background:#f44;margin-top:10px;">全データを消す</button>
    <button onclick="logout()" style="background:red;margin-top:10px;">ログアウト</button>
</div>

<script>
    let threads = [];
    let replies = [];
    let currentThreadId = null;
    let currentUser = null;
    const adminUser = 'yoda';

    const colorCssMap = {
        "レッド":"red","グリーン":"lime","イエロー":"yellow","ブルー":"deepskyblue",
        "オレンジ":"orange","パープル":"violet","ピンク":"hotpink","ブラック":"black",
        "ゴールド":"gold","シルバー":"silver","ブラウン":"brown","ホワイト":"white"
    };
    const fortunes = [
        "「幸せは、活動の中にある。」 — アリストテレス",
        "「小さなことを大きな愛で行いなさい。」 — マザー・テレサ",
        "「どれほどゆっくり進もうとも、止まりさえしなければ問題ではない。」 — 孔子",
        "「幸せは準備が整った心に訪れる。」 — ダライ・ラマ",
        "「行動は言葉よりも力を持つ。」 — ニーチェ",
        "「過去に縛られず、今を生きよ。」 — 孔子",
        "「幸せは、見つけるものではなく作るもの。」 — アリストテレス",
        "「答えは外にではなく、心の中にある。」 — デカルト",
        "「一歩踏み出す勇気が、世界を変える。」 — カント",
        "「心の平穏は、思考の整理から。」 — スピノザ",
        "「人生は自分で描くものだ。」 — エマーソン",
        "「簡素に生きよ、そうすれば幸福も近くなる。」 — ソロー"
    ];

    // デバッグ用の関数
    function debugLog(message) {
        const timestamp = new Date().toLocaleTimeString();
        const logMessage = `[${timestamp}] ${message}`;
        console.log(logMessage);
        const debugEl = document.getElementById('debugLog');
        debugEl.innerHTML += `<br>${logMessage}`;
        debugEl.scrollTop = debugEl.scrollHeight;
    }

    function updateStatus(message) {
        document.getElementById('statusInfo').textContent = `システム状態: ${message}`;
    }

    function clearDebugLog() {
        document.getElementById('debugLog').innerHTML = 'デバッグログ:<br>';
    }

    // API接続テスト
    async function testAPI() {
        debugLog('=== API接続テスト開始 ===');
        updateStatus('API接続テスト中...');
        
        try {
            // GETテスト
            debugLog('GET /api/threads テスト開始');
            const getResponse = await fetch('/api/threads');
            debugLog(`GET レスポンス: ${getResponse.status} ${getResponse.statusText}`);
            
            if (getResponse.ok) {
                const data = await getResponse.json();
                debugLog(`GET 成功: ${JSON.stringify(data)}`);
            } else {
                const errorText = await getResponse.text();
                debugLog(`GET エラー: ${errorText}`);
            }
            
            // POSTテスト
            debugLog('POST /api/threads テスト開始');
            const testData = {
                title: 'テストスレッド',
                content: 'API接続テストです',
                user: 'テストユーザー'
            };
            debugLog(`POSTデータ: ${JSON.stringify(testData)}`);
            
            const postResponse = await fetch('/api/threads', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(testData)
            });
            
            debugLog(`POST レスポンス: ${postResponse.status} ${postResponse.statusText}`);
            
            if (postResponse.ok) {
                const result = await postResponse.json();
                debugLog(`POST 成功: ${JSON.stringify(result)}`);
                updateStatus('API接続テスト成功');
            } else {
                const errorText = await postResponse.text();
                debugLog(`POST エラー: ${errorText}`);
                updateStatus('API接続テスト失敗');
            }
            
        } catch (error) {
            debugLog(`API接続テストエラー: ${error.message}`);
            updateStatus('API接続エラー');
        }
        
        debugLog('=== API接続テスト終了 ===');
    }

    // エラー表示用の関数
    function showError(message, containerId = 'threads') {
        const container = document.getElementById(containerId);
        container.innerHTML = `<div class="error">${message}</div>`;
        debugLog(`エラー表示: ${message}`);
    }

    async function loadData() {
        debugLog('データ読み込み開始');
        updateStatus('データ読み込み中...');
        
        try {
            debugLog('スレッド取得開始...');
            const threadResponse = await fetch('/api/threads');
            debugLog(`スレッドレスポンス: ${threadResponse.status} ${threadResponse.statusText}`);
            debugLog(`レスポンスURL: ${threadResponse.url}`);
            
            if (!threadResponse.ok) {
                const errorText = await threadResponse.text();
                debugLog(`スレッドエラー詳細: ${errorText}`);
                throw new Error(`スレッドの取得に失敗: ${threadResponse.status} - ${errorText}`);
            }
            
            threads = await threadResponse.json();
            debugLog(`取得したスレッド数: ${threads.length}`);
            debugLog(`スレッドデータ: ${JSON.stringify(threads)}`);
            
            debugLog('返信取得開始...');
            const replyResponse = await fetch('/api/replies');
            debugLog(`返信レスポンス: ${replyResponse.status} ${replyResponse.statusText}`);
            
            if (!replyResponse.ok) {
                const errorText = await replyResponse.text();
                debugLog(`返信エラー詳細: ${errorText}`);
                throw new Error(`返信の取得に失敗: ${replyResponse.status} - ${errorText}`);
            }
            
            replies = await replyResponse.json();
            debugLog(`取得した返信数: ${replies.length}`);
            
            renderThreads();
            if (currentThreadId) {
                renderReplies();
            }
            
            updateStatus('データ読み込み完了');
            debugLog('データ読み込み完了');
            
        } catch (error) {
            console.error('データの取得エラー:', error);
            debugLog(`データ取得エラー: ${error.message}`);
            showError(`データの読み込みに失敗しました: ${error.message}`);
            updateStatus('データ読み込み失敗');
        }
    }

    async function createThread() {
        const title = document.getElementById('title').value.trim();
        const content = document.getElementById('threadContent').value.trim();
        
        debugLog('=== スレッド作成開始 ===');
        debugLog(`タイトル: "${title}"`);
        debugLog(`内容: "${content}"`);
        debugLog(`ユーザー: "${currentUser}"`);
        
        if (!title || !content) {
            debugLog('バリデーションエラー: タイトルまたは内容が空');
            return alert('タイトルと本文を入力してください');
        }
        
        const requestData = { title, content, user: currentUser };
        debugLog(`リクエストデータ: ${JSON.stringify(requestData)}`);
        
        updateStatus('スレッド作成中...');
        
        try {
            debugLog('POSTリクエスト送信開始');
            const response = await fetch('/api/threads', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify(requestData)
            });
            
            debugLog(`レスポンス: ${response.status} ${response.statusText}`);
            debugLog(`レスポンスヘッダー: ${JSON.stringify([...response.headers.entries()])}`);
            
            const responseText = await response.text();
            debugLog(`レスポンス内容: ${responseText}`);
            
            if (!response.ok) {
                debugLog(`リクエスト失敗: ${response.status}`);
                throw new Error(`スレッド作成に失敗: ${response.status} - ${responseText}`);
            }
            
            let result;
            try {
                result = JSON.parse(responseText);
                debugLog(`作成成功: ${JSON.stringify(result)}`);
            } catch (parseError) {
                debugLog(`JSONパースエラー: ${parseError.message}`);
                throw new Error('サーバーからの応答が不正です');
            }
            
            document.getElementById('title').value = '';
            document.getElementById('threadContent').value = '';
            updateStatus('スレッド作成完了');
            debugLog('スレッド作成完了 - データ再読み込み開始');
            
            alert('スレッドを作成しました！');
            await loadData();
            
        } catch (error) {
            console.error('スレッド作成エラー:', error);
            debugLog(`スレッド作成エラー: ${error.message}`);
            updateStatus('スレッド作成失敗');
            alert(`スレッド作成に失敗しました: ${error.message}`);
        }
        
        debugLog('=== スレッド作成終了 ===');
    }

    async function deleteThread(threadId, threadUser) {
        if (threadUser !== currentUser && currentUser !== adminUser) {
            return alert('権限がありません');
        }
        if (!confirm('このスレッドを本当に削除しますか？')) return;
        
        debugLog(`スレッド削除開始: ${threadId}`);
        
        try {
            const response = await fetch('/api/threads', {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ threadId })
            });
            
            debugLog(`削除レスポンス: ${response.status}`);
            
            if (!response.ok) {
                throw new Error(`削除に失敗: ${response.status}`);
            }
            
            alert('スレッドを削除しました');
            loadData();
        } catch (error) {
            console.error('削除エラー:', error);
            debugLog(`削除エラー: ${error.message}`);
            alert('削除に失敗しました');
        }
    }

    function renderThreads() {
        const container = document.getElementById('threads');
        const loadingEl = document.getElementById('loadingThreads');
        loadingEl.style.display = 'none';
        container.innerHTML = '';
        
        debugLog(`スレッド表示開始: ${threads.length}件`);
        
        if (!Array.isArray(threads) || threads.length === 0) {
            container.innerHTML = '<p>スレッドはまだありません。</p>';
            debugLog('スレッドなし');
            return;
        }
        
        threads.forEach((t, index) => {
            debugLog(`スレッド${index}: ${JSON.stringify(t)}`);
            const div = document.createElement('div');
            div.className = 'thread';
            div.innerHTML = `
                <span><strong>${escapeHtml(t.title)}</strong> — ${escapeHtml(t.user)}</span>
                ${(t.user === currentUser || currentUser === adminUser) ? 
                    `<span class="delete-btn" onclick="deleteThread('${t.id}', '${t.user}')">[削除]</span>` : ''}
            `;
            div.onclick = (e) => {
                if (e.target.classList.contains('delete-btn')) return;
                openThread(t.id, t.title, t.content);
            };
            container.appendChild(div);
        });
        
        debugLog('スレッド表示完了');
    }

    function openThread(threadId, title, content) {
        currentThreadId = threadId;
        document.getElementById('threadTitle').textContent = title;
        document.getElementById('threadContentDisplay').textContent = content;
        document.getElementById('threadView').style.display = 'block';
        document.getElementById('threads').style.display = 'none';
        renderReplies();
    }

    function backToList() {
        document.getElementById('threadView').style.display = 'none';
        document.getElementById('threads').style.display = 'block';
        currentThreadId = null;
        renderThreads();
    }

    async function addReply() {
        const input = document.getElementById('replyContent');
        const text = input.value.trim();
        if (!text) return alert('返信内容を入力してください');
        
        debugLog(`返信作成開始: スレッドID=${currentThreadId}, 内容="${text}"`);
        
        try {
            const response = await fetch('/api/replies', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ threadId: currentThreadId, content: text, user: currentUser })
            });
            
            debugLog(`返信レスポンス: ${response.status}`);
            
            if (!response.ok) {
                throw new Error(`返信に失敗: ${response.status}`);
            }
            
            input.value = '';
            alert('返信しました！');
            loadData();
        } catch (error) {
            console.error('返信エラー:', error);
            debugLog(`返信エラー: ${error.message}`);
            alert('返信に失敗しました');
        }
    }

    async function deleteReply(replyId, replyUser) {
        if (replyUser !== currentUser && currentUser !== adminUser) {
            return alert('権限がありません');
        }
        
        try {
            const response = await fetch('/api/replies', {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ replyId })
            });
            
            if (!response.ok) {
                throw new Error(`削除に失敗: ${response.status}`);
            }
            
            alert('返信を削除しました');
            loadData();
        } catch (error) {
            console.error('削除エラー:', error);
            alert('削除に失敗しました');
        }
    }

    function renderReplies() {
        const container = document.getElementById('replies');
        const loadingEl = document.getElementById('loadingReplies');
        loadingEl.style.display = 'none';
        container.innerHTML = '';
        
        if (!Array.isArray(replies)) {
            return;
        }
        
        const threadReplies = replies.filter(r => {
            const reply = typeof r === 'string' ? JSON.parse(r) : r;
            return reply.threadId === currentThreadId;
        });
        
        threadReplies.forEach(r => {
            const reply = typeof r === 'string' ? JSON.parse(r) : r;
            const div = document.createElement('div');
            div.className = 'reply';
            div.innerHTML = `<strong>${escapeHtml(reply.user)}</strong>: ${escapeHtml(reply.content)}
                ${(reply.user === currentUser || currentUser === adminUser) ? 
                    `<span class="delete-btn" onclick="deleteReply('${reply.id}', '${reply.user}')">[削除]</span>` : ''}`;
            container.appendChild(div);
        });
    }

    async function resetAll() {
        if (!confirm('本当にすべてのデータを消去しますか？')) return;
        if(currentUser !== adminUser) return alert('管理者のみ全削除可能です');
        
        try {
            await Promise.all([
                fetch('/api/threads', { 
                    method: 'DELETE', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ threadId: 'all' }) 
                }),
                fetch('/api/replies', { 
                    method: 'DELETE', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ replyId: 'all' }) 
                })
            ]);
            alert('すべてのデータを消去しました！');
            loadData();
        } catch (error) {
            console.error('削除エラー:', error);
            alert('削除に失敗しました');
        }
    }

    function showFortune() {
        const zodiac = document.getElementById('zodiac').value;
        if (!zodiac) return alert('星座を選んでください');
        const colors = Object.keys(colorCssMap);
        const luckyColor = colors[Math.floor(Math.random() * colors.length)];
        const fortune = fortunes[Math.floor(Math.random() * fortunes.length)];
        document.getElementById('fortune').innerHTML =
            `${zodiac} の今日のラッキーカラー: <span style="color:${colorCssMap[luckyColor]};font-weight:bold;">${luckyColor}</span><br>${fortune}`;
    };

    function login() {
        let name = document.getElementById('username').value.trim();
        if(!name) name="名無し";
        currentUser = name;
        debugLog(`ユーザーログイン: ${currentUser}`);
        document.getElementById('currentUser').textContent = currentUser;
        document.getElementById('loginContainer').style.display='none';
        document.getElementById('mainContainer').style.display='block';
        updateStatus('ログイン完了');
        loadData();
    };

    function logout() {
        currentUser = null;
        document.getElementById('loginContainer').style.display='block';
        document.getElementById('mainContainer').style.display='none';
        updateStatus('ログアウト');
    };

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // ページ読み込み時の初期化
    window.addEventListener('load', () => {
        debugLog('ページ読み込み完了');
        updateStatus('初期化完了');
    });
</script>
</body>
</html>
